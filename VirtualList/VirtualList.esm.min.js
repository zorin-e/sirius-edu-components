import{defineComponent as e,toRefs as t,ref as i,computed as a,onMounted as s,onUpdated as o,onBeforeUnmount as r,openBlock as n,createElementBlock as l,renderSlot as d,onBeforeMount as u,watch as h,resolveComponent as c,normalizeClass as p,createVNode as f,withCtx as g,createElementVNode as m,normalizeStyle as v,Fragment as z,renderList as _,createBlock as x}from"vue";var S,I;!function(e){e.FRONT="FRONT",e.BEHIND="BEHIND"}(S||(S={})),function(e){e.INIT="INIT",e.FIXED="FIXED",e.DYNAMIC="DYNAMIC"}(I||(I={}));const y=(e,t)=>{const i={range:{},sizes:new Map,firstRangeTotalSize:0,firstRangeAverageSize:0,lastCalcIndex:0,fixedSizeValue:0,calcType:I.INIT,direction:null,param:e,callUpdate:t,offset:0,destroy(){this.range={},this.sizes=new Map,this.firstRangeTotalSize=0,this.firstRangeAverageSize=0,this.lastCalcIndex=0,this.fixedSizeValue=0,this.calcType=I.INIT,this.offset=0,this.direction=null},getRange(){const{start:e,end:t,padFront:i,padBehind:a}=this.range;return{start:e,end:t,padFront:i,padBehind:a}},isBehind(){return this.direction===S.BEHIND},isFront(){return this.direction===S.FRONT},getOffset(e){return(e<1?0:this.getIndexOffset(e))+this.param.slotHeaderSize},updateParam(e,t){this.param&&e in this.param&&("uniqueIds"===e&&this.sizes.forEach(((e,i)=>{!t.includes(i)&&this.sizes.delete(i)})),this.param[e]=t)},saveSize(e,t){this.sizes.set(e,t),this.calcType===I.INIT?(this.fixedSizeValue=t,this.calcType=I.FIXED):this.calcType===I.FIXED&&this.fixedSizeValue!==t&&(this.calcType=I.DYNAMIC,this.fixedSizeValue=null),this.calcType!==I.FIXED&&void 0!==this.firstRangeTotalSize&&(this.sizes.size<Math.min(this.param.keeps,this.param.uniqueIds.length)?(this.firstRangeTotalSize=[...this.sizes.values()].reduce(((e,t)=>e+t),0),this.firstRangeAverageSize=Math.round(this.firstRangeTotalSize/this.sizes.size)):this.firstRangeTotalSize=null)},handleItemsChange(){let e=this.range.start;this.isFront()?e-=5:this.isBehind()&&(e+=5),e=Math.max(e,0),this.updateRange(this.range.start,this.getEndByStart(e))},handleSlotSizeChange(){this.handleItemsChange()},handleScroll(e){this.direction=e<this.offset?S.FRONT:S.BEHIND,this.offset=e,this.param&&(this.direction===S.FRONT?this.handleFront():this.direction===S.BEHIND&&this.handleBehind())},handleFront(){const e=this.getScrollOvers();if(this.range.start&&e>this.range.start)return;const t=Math.max(e-this.param.buffer,0);this.checkRange(t,this.getEndByStart(t))},handleBehind(){const e=this.getScrollOvers();this.range.start&&e<this.range.start+this.param.buffer||this.checkRange(e,this.getEndByStart(e))},getScrollOvers(){const e=this.offset-this.param.slotHeaderSize;if(e<=0)return 0;if(this.isFixedType())return Math.floor(e/this.fixedSizeValue);let t=0,i=0,a=0,s=this.param.uniqueIds.length;for(;t<=s;){if(i=t+Math.floor((s-t)/2),a=this.getIndexOffset(i),a===e)return i;a<e?t=i+1:a>e&&(s=i-1)}return t>0?--t:0},getIndexOffset(e){if(!e)return 0;let t,i=0;for(let a=0;a<e;a++)t=this.sizes.get(this.param.uniqueIds[a]),i+="number"==typeof t?t:this.getEstimateSize();return this.lastCalcIndex=Math.max(this.lastCalcIndex,e-1),this.lastCalcIndex=Math.min(this.lastCalcIndex,this.getLastIndex()),i},isFixedType(){return this.calcType===I.FIXED},getLastIndex(){return this.param.uniqueIds.length-1},checkRange(e,t){const i=this.param.keeps;this.param.uniqueIds.length<=i?(e=0,t=this.getLastIndex()):t-e<i-1&&(e=t-i+1),this.range.start!==e&&this.updateRange(e,t)},updateRange(e,t){this.range.start=e,this.range.end=t,this.range.padFront=this.getPadFront(),this.range.padBehind=this.getPadBehind(),this.callUpdate(this.getRange())},getEndByStart(e){const t=e+this.param.keeps-1;return Math.min(t,this.getLastIndex())},getPadFront(){return this.isFixedType()?this.fixedSizeValue*this.range.start:this.getIndexOffset(this.range.start)},getPadBehind(){const e=this.range.end,t=this.getLastIndex();return this.isFixedType()?(t-e)*this.fixedSizeValue:this.lastCalcIndex===t?this.getIndexOffset(t)-this.getIndexOffset(e):(t-e)*this.getEstimateSize()},getEstimateSize(){return this.isFixedType()?this.fixedSizeValue:this.firstRangeAverageSize||this.param.estimateSize}};return e&&i.checkRange(0,e.keeps-1),i};var T=e({name:"VirtualListItem",props:{horizontal:{type:Boolean}},setup(e,n){const{horizontal:l}=t(e),d=i(null);let u=null;const h=a((()=>l.value?"offsetWidth":"offsetHeight"));s((()=>{"undefined"!=typeof ResizeObserver&&d.value&&(u=new ResizeObserver((()=>{c()})),u.observe(d.value))}));const c=()=>{n.emit("item-resize",p())},p=()=>d.value?d.value[h.value]:0;return o((()=>{c()})),r((()=>{u&&(u.disconnect(),u=null)})),{root:d}}});const R={ref:"root",role:"listitem"};var k;T.render=function(e,t,i,a,s,o){return n(),l("div",R,[d(e.$slots,"default")],512)},function(e){e.HORIZONTAL="horizontal",e.VERTICAL="vertical"}(k||(k={}));var b=e({components:{Item:T},name:"VirtualList",props:{items:{type:Array,required:!0},dataKey:{type:String,required:!0,default:"id"},keeps:{type:Number,default:50},estimateSize:{type:Number,default:50},pageMode:{type:Boolean},direction:{type:String,validator:e=>Object.values(k).includes(e),default:k.VERTICAL},start:{type:Number,default:0},offset:{type:Number,default:0},topThreshold:{type:Number,default:0},bottomThreshold:{type:Number,default:0}},setup(e,o){const{dataKey:n,items:l,direction:d,start:c,offset:p,topThreshold:f,bottomThreshold:g,keeps:m,pageMode:v}=t(e),z=i({}),_=i(null),x=i(null),S=a((()=>l.value.map((e=>e[n.value])))),I=a((()=>d.value===k.HORIZONTAL)),T=a((()=>I.value?"scrollLeft":"scrollTop")),R=y({slotHeaderSize:0,slotFooterSize:0,keeps:e.keeps,estimateSize:e.estimateSize,buffer:Math.round(e.keeps/3),uniqueIds:S.value},(e=>{z.value=e}));u((()=>{O(R.offset)})),s((()=>{c.value?b(c.value):p.value&&O(p.value),v.value&&(M(),document.addEventListener("scroll",C,{passive:!1}))}));const b=e=>{if(e>=l.value.length-1)E();else{const t=R.getOffset(e);O(t)}},E=()=>{if(x.value){const e=x.value[I.value?"offsetLeft":"offsetTop"];O(e),setTimeout((()=>{F()+N()<B()&&E()}))}},F=()=>v.value?document.documentElement[T.value]||document.body[T.value]:_.value?Math.ceil(_.value[T.value]):0,N=()=>{const e=I.value?"clientWidth":"clientHeight";return v.value?document.documentElement[e]||document.body[e]:_.value?Math.ceil(_.value[e]):0},B=()=>{const e=I.value?"scrollWidth":"scrollHeight";return v.value?document.documentElement[e]||document.body[e]:_.value?Math.ceil(_.value[e]):0},O=e=>{if(v.value)return document.body[T.value]=e,void(document.documentElement[T.value]=e);_.value&&(_.value[T.value]=e)},M=()=>{if(!_.value)return;const e=_.value.getBoundingClientRect(),{defaultView:t}=_.value.ownerDocument;if(t){const i=I.value?e.left+t.pageXOffset:e.top+t.pageYOffset;R.updateParam("slotHeaderSize",i)}},C=()=>{const e=F(),t=N(),i=B();e<0||e+t>i+1||!i||(R.handleScroll(e),((e,t,i)=>{R.isFront()&&l.value.length&&e-f.value<=0?o.emit("totop"):R.isBehind()&&e+t+g.value>=i&&o.emit("tobottom")})(e,t,i))};r((()=>{R.destroy(),v.value&&document.removeEventListener("scroll",C)}));const H=a((()=>{const{padBehind:e,padFront:t}=z.value;return{padding:I.value?`0px ${e}px 0px ${t}px`:`${t}px 0px ${e}px`}})),D=a((()=>{const{start:e,end:t}=z.value;return void 0===e||void 0===t?l.value:l.value.slice(e,t+1)}));return h(m,(e=>{R.updateParam("keeps",e),R.handleSlotSizeChange()})),h(c,(e=>{b(e)})),h(p,(e=>{O(e)})),h(l,(()=>{R.updateParam("uniqueIds",S.value),R.handleItemsChange()})),{root:_,shepherd:x,onScroll:C,groupStyle:H,isHorizontal:I,range:z,computedItems:D,onItemResized:(e,t)=>{R.saveSize(e,t)},onSlotResized:(e,t)=>{R.updateParam(e,t)},scrollToBottom:E}}});!function(e,t){void 0===t&&(t={});var i=t.insertAt;if(e&&"undefined"!=typeof document){var a=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.type="text/css","top"===i&&a.firstChild?a.insertBefore(s,a.firstChild):a.appendChild(s),s.styleSheet?s.styleSheet.cssText=e:s.appendChild(document.createTextNode(e))}}("._rootScrollable_horizontal_1kox7_1 {\n  overflow-x: auto;\n}\n._rootScrollable_vertical_1kox7_4 {\n  overflow-y: auto;\n}\n._root_1kox7_1,\n._group_1kox7_9 {\n  display: flex;\n}\n._root_horizontal_1kox7_12,\n._group_horizontal_1kox7_13 {\n  flex-direction: row;\n}\n._root_vertical_1kox7_16,\n._group_vertical_1kox7_17 {\n  flex-direction: column;\n}");(b.__cssModules={}).$style={rootScrollable_horizontal:"_rootScrollable_horizontal_1kox7_1",rootScrollable_vertical:"_rootScrollable_vertical_1kox7_4",root:"_root_1kox7_1",group:"_group_1kox7_9",root_horizontal:"_root_horizontal_1kox7_12",group_horizontal:"_group_horizontal_1kox7_13",root_vertical:"_root_vertical_1kox7_16",group_vertical:"_group_vertical_1kox7_17"},b.render=function(e,t,i,a,s,o){const r=c("item");return n(),l("div",{ref:"root",class:p([!e.pageMode&&e.$style.rootScrollable,!e.pageMode&&e.$style["rootScrollable_"+e.direction],e.$style.root,e.$style["root_"+e.direction]]),onScroll:t[2]||(t[2]=t=>!e.pageMode&&e.onScroll(t))},[f(r,{onItemResize:t[0]||(t[0]=t=>e.onSlotResized("slotHeaderSize",t))},{default:g((()=>[d(e.$slots,"before")])),_:3}),m("div",{role:"group",class:p([e.$style.group,e.$style["group_"+e.direction]]),style:v(e.groupStyle)},[(n(!0),l(z,null,_(e.computedItems,(t=>(n(),x(r,{key:t[e.dataKey],onItemResize:i=>e.onItemResized(t.id,i)},{default:g((()=>[d(e.$slots,"default",{item:t})])),_:2},1032,["onItemResize"])))),128))],6),f(r,{onItemResize:t[1]||(t[1]=t=>e.onSlotResized("slotFooterSize",t))},{default:g((()=>[d(e.$slots,"after")])),_:3}),m("div",{ref:"shepherd",style:v({width:e.isHorizontal?"0px":"100%",height:e.isHorizontal?"100%":"0px"})},null,4)],34)};export{b as default};
